<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>AI Kids Monitor</title>
    <style>
        body { background: #1e272e; color: #d2dae2; font-family: 'Segoe UI', sans-serif; text-align: center; margin: 0; }
        .container { max-width: 1280px; margin: 0 auto; padding: 20px; }
        
        /* HEADER */
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .btn-help { background: #f39c12; color: white; border: none; padding: 10px 20px; border-radius: 20px; cursor: pointer; font-weight: bold; font-size: 14px; }
        .btn-help:hover { background: #e67e22; }

        /* VIDEO GRID */
        .grid-container { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .cam-box { background: #000; border: 4px solid #485460; border-radius: 12px; overflow: hidden; position: relative; aspect-ratio: 16/9; }
        img { width: 100%; height: 100%; object-fit: contain; }
        .cam-title { position: absolute; top: 10px; left: 10px; background: rgba(0,0,0,0.7); padding: 5px 10px; border-radius: 5px; font-weight: bold; }

        /* TH·ªêNG K√ä L·ªñI */
        .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin: 20px 0; }
        .stat-card { background: #2f3640; padding: 15px; border-radius: 10px; border-top: 5px solid #7f8fa6; display: flex; flex-direction: column; align-items: center; }
        .stat-val { font-size: 36px; font-weight: bold; color: white; }
        .stat-name { font-size: 14px; color: #aaa; text-transform: uppercase; margin-top: 5px; }
        .card-neck { border-color: #f1c40f; } .card-back { border-color: #e67e22; }
        .card-tilt { border-color: #3498db; } .card-close { border-color: #9b59b6; }

        /* INPUT PANEL */
        .control-panel { background: #485460; padding: 15px; border-radius: 12px; display: flex; gap: 10px; justify-content: center; margin-bottom: 20px; align-items: center;}
        input { padding: 10px; border-radius: 5px; border: none; font-size: 16px; text-align: center; font-weight: bold; }
        #nameInput { width: 160px; background: #dfe6e9; color: #2d3436; }
        #ageInput { width: 60px; background: #dfe6e9; color: #2d3436; }
        #durationInput { width: 60px; background: #81ecec; color: #000; }
        button { padding: 10px 20px; border-radius: 5px; border: none; font-size: 16px; cursor: pointer; color: white; font-weight: bold;}
        #btnStart { background: #05c46b; } #btnStop { background: #ff3f34; display: none; }
        
        /* MODAL H∆Ø·ªöNG D·∫™N */
        .modal { display: none; position: fixed; z-index: 999; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8); }
        .modal-content { background-color: #fefefe; margin: 5% auto; padding: 20px; border: 1px solid #888; width: 60%; max-width: 700px; border-radius: 10px; color: #333; text-align: left; position: relative;}
        .close { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        .close:hover { color: black; }
        .step-box { background: #f1f2f6; padding: 15px; margin-bottom: 10px; border-radius: 8px; border-left: 5px solid #2ecc71; }
        .step-title { font-weight: bold; color: #2c3e50; font-size: 18px; margin-bottom: 5px;}
        h2 { color: #2c3e50; border-bottom: 2px solid #eee; padding-bottom: 10px;}

        /* TABLE */
        table { width: 100%; background: white; color: #333; border-collapse: collapse; border-radius: 8px; overflow: hidden; font-size: 14px;}
        th, td { padding: 10px; border-bottom: 1px solid #ddd; text-align: center; }
        th { background: #34495e; color: white; }
    </style>
    <link rel="icon" href="{[{ url_for('static', filename='favicon.png') }]}">
</head>
<body>

<div class="container">
    <div class="header">
        <h2 style="color: white; margin:0">üë∂ H·ªÜ TH·ªêNG GI√ÅM S√ÅT T∆Ø TH·∫æ H·ªåC T·∫¨P</h2>
        <button class="btn-help" onclick="openHelp()">‚ùì H∆∞·ªõng D·∫´n C√†i ƒê·∫∑t</button>
    </div>
    
    <div class="grid-container">
        <div class="cam-box" id="box-front"><div class="cam-title">CAM TR∆Ø·ªöC (Nghi√™ng / D√≠ M·∫Øt)</div><img src="{{ url_for('video_front') }}"></div>
        <div class="cam-box" id="box-side"><div class="cam-title">CAM C·∫†NH (G√π C·ªï / G√π L∆∞ng)</div><img src="{{ url_for('video_side') }}"></div>
    </div>
    
    <div class="stats-grid">
        <div class="stat-card card-neck"><div class="stat-val" id="cnt-neck">0</div><div class="stat-name">G√π C·ªï</div></div>
        <div class="stat-card card-back"><div class="stat-val" id="cnt-back">0</div><div class="stat-name">G√π L∆∞ng</div></div>
        <div class="stat-card card-tilt"><div class="stat-val" id="cnt-tilt">0</div><div class="stat-name">Nghi√™ng ƒê·∫ßu</div></div>
        <div class="stat-card card-close"><div class="stat-val" id="cnt-close">0</div><div class="stat-name">D√≠ M·∫Øt</div></div>
    </div>
    
    <div id="statusMessage" style="color:#aaa; margin-bottom: 10px; font-weight:bold;">S·∫µn s√†ng...</div>
    
    <div style="font-size: 24px; font-weight: bold; color: #00bcd4; margin-bottom: 15px; display: none;" id="timerDisplay">
        ‚è±Ô∏è Th·ªùi gian c√≤n l·∫°i: <span id="timerText">00:00</span>
    </div>

    <div class="control-panel">
        <input type="text" id="nameInput" placeholder="T√™n B√©">
        <input type="number" id="ageInput" placeholder="Tu·ªïi">
        <span style="color: white;">| M·ª•c ti√™u:</span>
        <input type="number" id="durationInput" value="45"> ph√∫t

        <button id="btnStart" onclick="startSession()">‚ñ∂ B·∫ÆT ƒê·∫¶U</button>
        <button id="btnStop" onclick="finishSession()">‚èπ K·∫æT TH√öC</button>
        <button onclick="calibrate()" style="background:#0fb9b1;">üéØ Set Chu·∫©n</button>
    </div>

    <h3>üìú L·ªãch s·ª≠ r√®n luy·ªán</h3>
    <table>
        <thead>
            <tr>
                <th>Th·ªùi gian</th>
                <th>T√™n B√©</th>
                <th>Tu·ªïi</th>
                <th>H·ªçc th·∫≠t</th>
                <th>T·ªïng L·ªói</th>
                <th>Chi ti·∫øt c√°c l·ªói</th>
            </tr>
        </thead>
        <tbody id="historyBody"></tbody>
    </table>
</div>

<div id="helpModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeHelp()">&times;</span>
        <h2>üìñ H∆∞·ªõng d·∫´n s·ª≠ d·ª•ng chu·∫©n</h2>
        
        <div class="step-box">
            <div class="step-title">B∆∞·ªõc 1: ƒê·∫∑t Camera ƒë√∫ng v·ªã tr√≠</div>
            <p>üì∑ <strong>Cam Tr∆∞·ªõc (Cam 1):</strong> ƒê·∫∑t tr√™n m√†n h√¨nh m√°y t√≠nh, chi·∫øu th·∫≥ng v√†o m·∫∑t b√©.</p>
            <p>üìπ <strong>Cam C·∫°nh (Cam 2):</strong> ƒê·∫∑t ngang h√¥ng, c√°ch kho·∫£ng 1.5m. Ph·∫£i nh√¨n th·∫•y ƒë∆∞·ª£c: <strong>Tai - Vai - H√¥ng</strong> c·ªßa b√©.</p>
        </div>

        <div class="step-box">
            <div class="step-title">B∆∞·ªõc 2: Thi·∫øt l·∫≠p t∆∞ th·∫ø chu·∫©n</div>
            <p>Cho b√© ng·ªìi th·∫≥ng l∆∞ng, m·∫Øt nh√¨n th·∫≥ng v√†o m√†n h√¨nh, tay ƒë·ªÉ l√™n b√†n tho·∫£i m√°i.</p>
            <p>üëâ B·∫•m n√∫t <strong>"üéØ Set Chu·∫©n"</strong>. Khi m√°y b√°o th√†nh c√¥ng l√† ƒë∆∞·ª£c.</p>
        </div>

        <div class="step-box">
            <div class="step-title">B∆∞·ªõc 3: B·∫Øt ƒë·∫ßu h·ªçc</div>
            <p>Nh·∫≠p <strong>T√™n</strong>, <strong>Tu·ªïi</strong> v√† b·∫•m <strong>"‚ñ∂ B·∫ÆT ƒê·∫¶U"</strong>.</p>
            <p>üîä N·∫øu b√© ng·ªìi sai qu√° 3 gi√¢y, m√°y s·∫Ω b√°o ƒë·ªông. N·∫øu b√© ch·∫°y ra ngo√†i, m√°y s·∫Ω t·ª± t·∫°m d·ª´ng.</p>
        </div>
        
        <div style="text-align: center; margin-top: 15px;">
            <button onclick="closeHelp()" style="background: #34495e;">ƒê√£ Hi·ªÉu</button>
        </div>
    </div>
</div>

<audio id="alarmSound" src="https://assets.mixkit.co/sfx/preview/mixkit-alarm-digital-clock-beep-989.mp3"></audio>

<script>
    loadHistory();
    // T·ª± ƒë·ªông m·ªü h∆∞·ªõng d·∫´n n·∫øu l√† l·∫ßn ƒë·∫ßu (ho·∫∑c refresh trang)
    // setTimeout(openHelp, 1000); 

    function openHelp() { document.getElementById("helpModal").style.display = "block"; }
    function closeHelp() { document.getElementById("helpModal").style.display = "none"; }
    
    // ƒê√≥ng modal khi click ra ngo√†i
    window.onclick = function(event) {
        if (event.target == document.getElementById("helpModal")) {
            closeHelp();
        }
    }

    let sessionStartTime = null;
    let sessionDuration = 0;
    let timerInterval = null;

    function startSession() {
        const name = document.getElementById('nameInput').value;
        const age = document.getElementById('ageInput').value;
        const dur = document.getElementById('durationInput').value;
        if(!name || !age) { alert("Vui l√≤ng nh·∫≠p T√™n v√† Tu·ªïi!"); return; }
        fetch('/start_session', {
            method:'POST', headers:{'Content-Type':'application/json'}, 
            body:JSON.stringify({name: name, age: age, duration: dur})
        }).then(res=>res.json()).then(d => {
            document.getElementById('nameInput').disabled = true;
            document.getElementById('ageInput').disabled = true;
            document.getElementById('btnStart').style.display='none';
            document.getElementById('btnStop').style.display='inline-block';
            document.getElementById('timerDisplay').style.display = 'block';
            resetCounts();
            
            sessionStartTime = Date.now();
            sessionDuration = parseInt(dur) * 60 * 1000; // Chuy·ªÉn ph√∫t sang mili gi√¢y
            startCountdown();
        });
    }

    function startCountdown() {
        if(timerInterval) clearInterval(timerInterval);
        timerInterval = setInterval(() => {
            const elapsed = Date.now() - sessionStartTime;
            const remaining = Math.max(0, sessionDuration - elapsed);
            
            const totalSeconds = Math.floor(remaining / 1000);
            const mins = Math.floor(totalSeconds / 60);
            const secs = totalSeconds % 60;
            
            document.getElementById('timerText').innerText = 
                String(mins).padStart(2, '0') + ':' + String(secs).padStart(2, '0');
            
            if(remaining <= 0) {
                clearInterval(timerInterval);
                finishSession();
            }
        }, 100);
    }

    function finishSession() {
        if(timerInterval) clearInterval(timerInterval);
        fetch('/stop_session', {method:'POST'}).then(res=>res.json()).then(d => {
            const sumErr = d.errors.neck + d.errors.back + d.errors.tilt + d.errors.close;
            alert(`K·∫æT TH√öC!\n- T·ªïng l·ªói: ${sumErr}`);
            document.getElementById('nameInput').disabled = false;
            document.getElementById('ageInput').disabled = false;
            document.getElementById('btnStart').style.display='inline-block';
            document.getElementById('btnStop').style.display='none';
            document.getElementById('timerDisplay').style.display = 'none';
            loadHistory();
        });
    }

    function calibrate() { fetch('/calibrate_front').then(r=>r.json()).then(d=>alert(d.status === 'success' ? "‚úÖ ƒê√£ l∆∞u t∆∞ th·∫ø chu·∫©n!" : "‚ùå L·ªói Cam!")); }
    function resetCounts() { ['neck','back','tilt','close'].forEach(k => document.getElementById(`cnt-${k}`).innerText = "0"); }

    function loadHistory() {
        fetch('/get_history').then(r=>r.json()).then(logs => {
            const tb = document.getElementById('historyBody'); tb.innerHTML="";
            logs.forEach(log => {
                const err = parseInt(log['T·ªïng L·ªói']);
                let details = `C·ªï:${log['G√π C·ªï']} | L∆∞ng:${log['G√π L∆∞ng']} | M·∫Øt:${log['D√≠ M·∫Øt']}`;
                tb.innerHTML += `<tr>
                    <td>${log['Th·ªùi gian']}</td>
                    <td style="font-weight:bold">${log['T√™n B√©']}</td>
                    <td>${log['Tu·ªïi']}</td>
                    <td>${log['Th·ª±c h·ªçc(p)']}p</td>
                    <td style="font-weight:bold; color:#ff3f34">${err}</td>
                    <td style="font-size:13px; color:#555">${details}</td>
                </tr>`;
            });
        });
    }

    setInterval(() => {
        fetch('/check_status').then(r=>r.json()).then(data => {
            const aud = document.getElementById('alarmSound');
            const msg = document.getElementById('statusMessage');
            if(data.counts) {
                document.getElementById('cnt-neck').innerText = data.counts.neck;
                document.getElementById('cnt-back').innerText = data.counts.back;
                document.getElementById('cnt-tilt').innerText = data.counts.tilt;
                document.getElementById('cnt-close').innerText = data.counts.close;
            }
            if(!data.active) return;
            if(data.absent) {
                msg.innerText = "‚ö†Ô∏è B√â V·∫ÆNG M·∫∂T (ƒêANG NGH·ªà)"; msg.style.color = "yellow"; aud.pause(); return;
            }
            if(data.alarm) {
                msg.innerText = "üö® SAI T∆Ø TH·∫æ!"; msg.style.color = "red"; aud.play().catch(()=>{});
            } else {
                msg.innerText = "‚úÖ T∆Ø TH·∫æ T·ªêT"; msg.style.color = "#2ecc71"; aud.pause(); aud.currentTime=0;
            }
        });
    }, 500);
</script>

</body>
</html>